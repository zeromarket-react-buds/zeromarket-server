<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.zeromarket.server.api.mapper.order.TradeHistoryMapper">

    <resultMap id="TradeHistoryResponseMap"
               type="com.zeromarket.server.api.dto.order.TradeHistoryResponse">

        <id     column="trade_id"      property="tradeId"/>
        <result column="product_id"    property="productId"/>
        <result column="product_title" property="productTitle"/>
        <result column="thumbnail_url" property="thumbnailUrl"/>
        <result column="sell_price"    property="sellPrice"/>

        <result column="trade_type"
                property="tradeType"
                javaType="com.zeromarket.server.common.enums.TradeType"/>
        <result column="trade_status"
                property="tradeStatus"
                javaType="com.zeromarket.server.common.enums.TradeStatus"/>

        <result column="is_direct"     property="isDirect"/>
        <result column="is_delivery"   property="isDelivery"/>
        <result column="seller_deleted" property="sellerDeleted"/>
        <result column="buyer_deleted"  property="buyerDeleted"/>
        <result column="created_at"    property="createdAt"/>
        <result column="updated_at"    property="updatedAt"/>
        <result column="completed_at"  property="completedAt"/>
        <result column="canceled_at"   property="canceledAt"/>
    </resultMap>

    <select id="selectTradeList"
            parameterType="com.zeromarket.server.api.dto.order.TradeHistoryRequest"
            resultMap="TradeHistoryResponseMap">
        SELECT
            t.trade_id,
            t.product_id,
            p.product_title,
            pi.image_url AS thumbnail_url,
            p.sell_price,
            t.trade_type,
            t.trade_status,
            p.is_direct,
            p.is_delivery,
            t.seller_deleted,
            t.buyer_deleted,
            t.created_at,
            t.updated_at,
            t.completed_at,
            t.canceled_at
        FROM trade t

        JOIN product p
        ON p.product_id = t.product_id

        LEFT JOIN product_image pi
        ON pi.product_id = p.product_id
        AND pi.is_main = TRUE
        WHERE 1 = 1

        <if test="keyword != null and keyword != ''">
            AND p.product_title ILIKE CONCAT('%', #{keyword}, '%')
        </if>

        ORDER BY t.created_at DESC

    </select>

    <resultMap id="TradeReviewInfoMap" type="com.zeromarket.server.api.dto.mypage.TradeReviewInfoDto">
        <id property="tradeId" column="trade_id"/>

        <result property="productId" column="product_id"/>
        <result property="productTitle" column="product_title"/>
        <result property="productImageUrl" column="product_image_url"/>
        <result property="opponentNickname" column="opponent_nickname"/>
    </resultMap>

    <select id="selectTradeInfoForReview"
        parameterType="map"
        resultMap="TradeReviewInfoMap">
        SELECT
        t.trade_id,
        p.product_id,
        p.product_title,

        pi.image_url AS product_image_url,

        CASE
        WHEN #{loginMemberId} = buyer.member_id
        THEN seller.nickname
        ELSE buyer.nickname
        END AS opponent_nickname

        FROM trade t
        JOIN product p
        ON t.product_id = p.product_id
        LEFT JOIN product_image pi
        ON p.product_id = pi.product_id
        AND pi.is_main = TRUE
        JOIN member seller
        ON p.seller_id = seller.member_id
        JOIN member buyer
        ON t.buyer_id = buyer.member_id

        WHERE t.trade_id = #{tradeId}
        AND t.trade_status = 'COMPLETED'
        AND p.is_deleted = FALSE
    </select>


</mapper>