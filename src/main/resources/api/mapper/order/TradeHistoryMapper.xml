<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.zeromarket.server.api.mapper.order.TradeHistoryMapper">

    <!-- 거래내역 목록 조회 -->
    <resultMap id="TradeHistoryResponseMap"
               type="com.zeromarket.server.api.dto.order.TradeHistoryResponse">

        <id     column="product_id"    property="productId"/>

        <result column="trade_id"      property="tradeId"/>
        <result column="buyer_id"      property="buyerId"/>

        <result column="product_title" property="productTitle"/>
        <result column="thumbnail_url" property="thumbnailUrl"/>
        <result column="sell_price"    property="sellPrice"/>

        <result column="trade_type"
                property="tradeType"
                javaType="com.zeromarket.server.common.enums.TradeType"/>
        <result column="trade_status"
                property="tradeStatus"
                javaType="com.zeromarket.server.common.enums.TradeStatus"/>

        <result column="is_direct"     property="isDirect"/>
        <result column="is_delivery"   property="isDelivery"/>

        <result column="is_hidden"     property="isHidden"/>

        <result column="seller_deleted" property="sellerDeleted"/>
        <result column="buyer_deleted"  property="buyerDeleted"/>

        <result column="created_at"    property="createdAt"/>
        <result column="updated_at"    property="updatedAt"/>
        <result column="completed_at"  property="completedAt"/>
        <result column="canceled_at"   property="canceledAt"/>
    </resultMap>

    <select id="selectTradeList"
            parameterType="com.zeromarket.server.api.dto.order.TradeHistoryRequest"
            resultMap="TradeHistoryResponseMap">
        SELECT
            p.product_id,
            t.trade_id,
            t.buyer_id,
            p.product_title,
            pi.image_url AS thumbnail_url,
            p.sell_price,
            t.trade_type,
            t.trade_status,
            p.is_direct,
            p.is_delivery,
            p.is_hidden,
            t.seller_deleted,
            t.buyer_deleted,
            t.created_at,
            t.updated_at,
            t.completed_at,
            t.canceled_at
        FROM product p

        LEFT JOIN trade t
            ON t.trade_id = (
                SELECT t.trade_id
                FROM trade t
                WHERE t.product_id = p.product_id
                ORDER BY t.created_at DESC
                LIMIT 1
            )

        LEFT JOIN product_image pi
            ON pi.product_id = p.product_id
            AND pi.is_main = TRUE

        WHERE
            p.is_deleted = FALSE
            AND (
                <!-- 판매 내역: 판매자 + 숨기기 상품 보임 -->
                (#{role} = 'SALES'
                    AND p.seller_id = #{memberId})
                <!-- 구매 내역: 구매자 -->
                OR (#{role} = 'PURCHASES'
                    AND t.buyer_id = #{memberId}
                    AND p.is_hidden = FALSE)
            )

        <if test="keyword != null and keyword != ''">
            AND p.product_title ILIKE CONCAT('%', #{keyword}, '%')
        </if>

        <!-- 상태 / 숨기기 조합 -->
        <choose>
            <!-- 상태도 있고 isHidden도 선택된 경우 -->
            <when test="tradeStatus != null and tradeStatus.size() > 0
                        and isHidden != null and isHidden == true">
                AND (
                    t.trade_status IN
                    <foreach item="ts" collection="tradeStatus" open="(" separator="," close=")">
                        #{ts}
                    </foreach>
                    OR p.is_hidden = TRUE
                )
            </when>

            <!-- 상태만 선택된 경우 -->
            <when test="tradeStatus != null and tradeStatus.size() > 0">
                AND t.trade_status IN
                <foreach item="ts" collection="tradeStatus" open="(" separator="," close=")">
                    #{ts}
                </foreach>
            </when>

            <!-- isHidden만 선택된 경우 -->
            <when test="isHidden != null and isHidden == true">
                AND p.is_hidden = TRUE
            </when>
        </choose>

        <if test="fromDate != null">
            AND COALESCE(t.created_at, p.created_at) >= #{fromDate}
        </if>

        <if test="toDate != null">
            AND COALESCE(t.created_at, p.created_at) &lt; (#{toDate} + 1)
        </if>

        ORDER BY
            COALESCE(t.created_at, p.created_at) DESC

    </select>

    <!-- 거래내역 상세 조회 -->
    <resultMap id="TradeProductResponseMap"
               type="com.zeromarket.server.api.dto.order.TradeProductResponse">

        <id     column="product_id"    property="productId"/>
        <result column="trade_id"      property="tradeId"/>

        <result column="product_title" property="productTitle"/>
        <result column="thumbnail_url" property="thumbnailUrl"/>
        <result column="sell_price"    property="sellPrice"/>

        <result column="canceled_by"   property="canceledBy"/>
        <result column="seller_id"     property="sellerId"/>
        <result column="buyer_id"      property="buyerId"/>

        <result column="nickname"      property="nickname"/>
        <result column="name"          property="name"/>
        <result column="phone"         property="phone"/>

        <result column="trade_type"
                property="tradeType"
                javaType="com.zeromarket.server.common.enums.TradeType"/>
        <result column="trade_status"
                property="tradeStatus"
                javaType="com.zeromarket.server.common.enums.TradeStatus"/>

        <result column="created_at"    property="createdAt"/>
        <result column="updated_at"    property="updatedAt"/>
        <result column="completed_at"  property="completedAt"/>
        <result column="canceled_at"   property="canceledAt"/>
    </resultMap>

    <select id="selectTradeProduct"
            parameterType="com.zeromarket.server.api.dto.order.TradeProductRequest"
            resultMap="TradeProductResponseMap">
        SELECT
            t.trade_id,
            p.product_id,
            p.product_title,
            pi.image_url AS thumbnail_url,
            p.sell_price,
            t.canceled_by,
            ms.member_id    AS seller_id,
            mb.member_id    AS buyer_id,
            ms.nickname     AS nickname,
            mb.name         AS name,
            mb.phone        AS phone,
            t.trade_type,
            t.trade_status,
            t.created_at,
            t.updated_at,
            t.completed_at,
            t.canceled_at
        FROM trade t

        JOIN product p
            ON p.product_id = t.product_id
        JOIN member ms
            ON ms.member_id = p.seller_id
        JOIN member mb
            ON mb.member_id = t.buyer_id
        LEFT JOIN product_image pi
            ON pi.product_id = p.product_id
            AND pi.is_main = TRUE
        WHERE t.trade_id = #{tradeId}

    </select>

    <!-- 상태 변경용 단건 조회 -->
    <select id="selectById"
            parameterType="long"
            resultType="com.zeromarket.server.api.dto.order.TradeStatusUpdateRow">
        SELECT
            t.trade_id      AS tradeId,
            p.seller_id     AS sellerId,
            t.buyer_id      AS buyerId,
            t.trade_status  AS tradeStatus,
            t.completed_at  AS completedAt
        FROM trade t

        JOIN product p
            ON p.product_id = t.product_id

        WHERE t.trade_id = #{tradeId}
    </select>

    <!-- 상태 및 완료 시간 업데이트 -->
    <update id="updateTradeStatus">
        UPDATE trade
            SET trade_status = #{target},
                completed_at = #{completedAt},
                canceled_at  = #{canceledAt},
                canceled_by  = #{canceledBy},
                updated_at   = #{updatedAt}
        WHERE trade_id = #{tradeId}
    </update>

    <resultMap id="TradeReviewInfoMap" type="com.zeromarket.server.api.dto.mypage.TradeReviewInfoDto">
        <id property="tradeId" column="trade_id"/>

        <result property="productId" column="product_id"/>
        <result property="productTitle" column="product_title"/>
        <result property="productImageUrl" column="product_image_url"/>
        <result property="opponentNickname" column="opponent_nickname"/>
    </resultMap>

    <select id="selectTradeInfoForReview"
        parameterType="map"
        resultMap="TradeReviewInfoMap">
        SELECT
        t.trade_id,
        p.product_id,
        p.product_title,

        pi.image_url AS product_image_url,

        CASE
        WHEN #{loginMemberId} = buyer.member_id
        THEN seller.nickname
        ELSE buyer.nickname
        END AS opponent_nickname

        FROM trade t
        JOIN product p
        ON t.product_id = p.product_id
        LEFT JOIN product_image pi
        ON p.product_id = pi.product_id
        AND pi.is_main = TRUE
        JOIN member seller
        ON p.seller_id = seller.member_id
        JOIN member buyer
        ON t.buyer_id = buyer.member_id

        WHERE t.trade_id = #{tradeId}
        AND t.trade_status = 'COMPLETED'
        AND p.is_deleted = FALSE
    </select>

    <resultMap id="TradeStatusMap" type="map">
        <result column="sellerId" property="sellerId" javaType="java.lang.Long"/>
        <result column="buyerId" property="buyerId" javaType="java.lang.Long"/>

        <result column="tradeStatus"
            property="tradeStatus"
            javaType="com.zeromarket.server.common.enums.TradeStatus"
            typeHandler="org.apache.ibatis.type.EnumTypeHandler"/>
    </resultMap>

    <select id="selectSellerBuyerStatusByTradeId"
        parameterType="long"
        resultMap="TradeStatusMap">
        SELECT seller.member_id AS sellerId,
        t.buyer_id AS buyerId,
        t.trade_status AS tradeStatus
        FROM trade t
        JOIN product p ON t.product_id = p.product_id
        JOIN member seller ON p.seller_id = seller.member_id
        WHERE t.trade_id = #{tradeId}
    </select>
</mapper>