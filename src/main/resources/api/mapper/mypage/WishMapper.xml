<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.zeromarket.server.api.mapper.mypage.WishMapper">

    <!-- 찜 조회 -->
    <select id="findWish" resultType="com.zeromarket.server.common.entity.Wish">
        SELECT *
        FROM wish
        WHERE member_id = #{memberId}
        AND product_id = #{productId}
    </select>

    <!-- 찜 생성 -->
    <insert id="insertWish"
        parameterType="com.zeromarket.server.common.entity.Wish"
        useGeneratedKeys="true"
        keyProperty="wishId"
        keyColumn="wish_id">
        INSERT INTO wish (member_id, product_id, is_deleted)
        VALUES (#{memberId}, #{productId}, false)
    </insert>

    <!-- 찜 복원 -->
    <update id="restoreWish">
        UPDATE wish
        SET is_deleted = false,
        updated_at = CURRENT_TIMESTAMP
        WHERE wish_id = #{wishId}
    </update>

    <!-- 찜 삭제 -->
    <update id="softDeleteWish">
        UPDATE wish
        SET is_deleted = true,
        updated_at = CURRENT_TIMESTAMP
        WHERE wish_id = #{wishId}
    </update>

    <!-- 찜 여부 -->
    <select id="isWished" resultType="boolean">
        SELECT COUNT(*) > 0
        FROM wish
        WHERE member_id = #{memberId}
        AND product_id = #{productId}
        AND is_deleted = false
    </select>

    <!-- 찜한 상품 목록 -->
    <select id="findWishProductIds" resultType="long">
        SELECT product_id
        FROM wish
        WHERE member_id = #{memberId}
        AND is_deleted = false
        ORDER BY created_at DESC
        LIMIT #{size}
        OFFSET #{offset}
    </select>

    <!-- ⭐찜 상품 요약 조회 → memberId + productId 둘 다 받아야 함 -->
    <select id="selectProductSummary"
        resultType="com.zeromarket.server.api.dto.mypage.WishProductResponse">

        SELECT
        p.product_id,
        p.product_title,
        p.sell_price,
        p.sales_status AS salesStatus,

        CASE p.sales_status
        WHEN 'FOR_SALE' THEN '판매중'
        WHEN 'RESERVED' THEN '예약중'
        WHEN 'SOLD_OUT' THEN '거래완료'
        END AS salesStatusKr,

        p.product_status,

        (SELECT pi.image_url
        FROM product_image pi
        WHERE pi.product_id = p.product_id
        ORDER BY pi.is_main DESC, pi.sort_order ASC
        LIMIT 1) AS thumbnailUrl,

        w.created_at AS createdAt,

        p.is_direct AS direct,
        p.is_delivery AS delivery,

        CASE
        WHEN p.is_direct = TRUE AND p.is_delivery = TRUE THEN '직거래 · 택배거래'
        WHEN p.is_direct = TRUE THEN '직거래'
        WHEN p.is_delivery = TRUE THEN '택배거래'
        ELSE '거래정보없음'
        END AS tradeTypeDisplay

        FROM wish w
        JOIN product p ON w.product_id = p.product_id

        <!-- ⭐memberId, productId -->
        WHERE w.member_id = #{memberId}
        AND w.product_id = #{productId}
        AND w.is_deleted = FALSE
        AND p.is_deleted = FALSE
        AND p.is_hidden = FALSE
        AND p.sales_status != 'SOLD_OUT'

        LIMIT 1
    </select>

</mapper>
