<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.zeromarket.server.api.mapper.mypage.ReviewMapper">

    <!-- ResultMap 정의 -->
    <resultMap id="ReviewResultMap" type="com.zeromarket.server.common.entity.Review">
        <id property="reviewId" column="review_id"/>
        <result property="writerId" column="writer_id"/>
        <result property="tradeId" column="trade_id"/>
        <result property="reviewedBy" column="reviewed_by"/>
        <result property="rating" column="rating"/>
        <result property="content" column="content"/>
        <result property="isDeleted" column="is_deleted"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
    </resultMap>

    <!--  리뷰 저장  -->
    <insert id="insertReview" parameterType="com.zeromarket.server.common.entity.Review"
        useGeneratedKeys="true" keyProperty="reviewId">
        INSERT INTO review (
        writer_id,
        trade_id,
        reviewed_by,
        rating,
        content
        )
        VALUES (
        #{writerId},
        #{tradeId},
        #{reviewedBy},
        #{rating},
        #{content}
        )
    </insert>

    <!-- 리뷰 ID로 조회 -->
    <select id="selectReviewById" resultMap="ReviewResultMap">
        SELECT * FROM review
        WHERE review_id = #{reviewId}
        AND is_deleted = false
    </select>

    <!-- 모든 리뷰 조회 -->
    <select id="selectAllReviews" resultMap="ReviewResultMap">
        SELECT * FROM review
        WHERE is_deleted = false
        ORDER BY created_at DESC
    </select>

    <!-- 작성자 ID로 리뷰 조회 (내가 작성한 리뷰) -->
    <select id="selectReviewsByWriterId" resultType="com.zeromarket.server.common.entity.Review">
        SELECT * FROM review
        WHERE writer_id = #{writerId}
        AND is_deleted = false
        ORDER BY created_at DESC
    </select>

    <!-- 거래 ID로 리뷰 조회 -->
    <select id="selectReviewsByTradeId" resultMap="ReviewResultMap">
        SELECT * FROM review
        WHERE trade_id = #{tradeId}
        AND is_deleted = false
        ORDER BY created_at DESC
    </select>

    <!-- 특정 회원이 받은 리뷰 조회 -->
    <select id="selectReviewsByMemberId" resultMap="ReviewResultMap">
        SELECT r.*
        FROM review r
        INNER JOIN trade t ON r.trade_id = t.trade_id
        INNER JOIN product p ON t.product_id = p.product_id
        WHERE (
        (r.reviewed_by = 'SELLER' AND p.seller_id = #{memberId})
        OR
        (r.reviewed_by = 'BUYER' AND t.buyer_id = #{memberId})
        )
        AND r.is_deleted = false
        ORDER BY r.created_at DESC
    </select>

    <!-- 평점별 리뷰 조회 -->
    <select id="selectReviewsByRating" resultMap="ReviewResultMap">
        SELECT * FROM review
        WHERE rating = #{rating}
        AND is_deleted = false
        ORDER BY created_at DESC
    </select>

    <!-- 회원의 평균 평점 조회 -->
    <select id="selectAverageRatingByMemberId" resultType="double">
        SELECT COALESCE(AVG(r.rating), 0.0) as avg_rating
        FROM review r
        INNER JOIN trade t ON r.trade_id = t.trade_id
        INNER JOIN product p ON t.product_id = p.product_id
        WHERE (
        (r.reviewed_by = 'SELLER' AND p.seller_id = #{memberId})
        OR
        (r.reviewed_by = 'BUYER' AND t.buyer_id = #{memberId})
        )
        AND r.is_deleted = false
    </select>

    <!-- 리뷰 수정 -->
    <update id="updateReview" parameterType="com.zeromarket.server.common.entity.Review">
        UPDATE review
        SET updated_at = CURRENT_TIMESTAMP
        <if test="rating != null">, rating = #{rating}</if>
        <if test="content != null">, content = #{content}</if>
        WHERE review_id = #{reviewId}
        AND is_deleted = false
    </update>

    <!-- 리뷰 삭제 (소프트 삭제) -->
    <update id="deleteReview">
        UPDATE review
        SET is_deleted = true,
        updated_at = CURRENT_TIMESTAMP
        WHERE review_id = #{reviewId}
    </update>

    <!-- 리뷰 완전 삭제 -->
    <delete id="hardDeleteReview">
        DELETE FROM review
        WHERE review_id = #{reviewId}
    </delete>

</mapper>